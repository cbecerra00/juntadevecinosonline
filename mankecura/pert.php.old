<?
include_once "lib/lib.inc";
session_start();
ini_set("session.cookie_domain", ".mankecura.com");
is_logeado();
top();
$connect = db();
$anio=ucfirst(strftime("%Y"));
?>
            <div class="row wrapper border-bottom white-bg page-heading">
                <div class="col-sm-8">
                    <h2>Detalles del pol&iacute;gono</h2>
                    <ol class="breadcrumb">
<?
$query_c = "SELECT T.Titu_Nombre,P.Proy_Nombre FROM Titular T, Proyecto P WHERE T.Titu_ID=P.Titular_Titu_ID AND T.Titu_ID=$_GET[c] AND P.Proy_ID=$_GET[p];";
#print "$query_c\n";
$result_c = mysqli_query($connect, $query_c);
while($row_c = mysqli_fetch_array($result_c)) {
   $com = $row_c[0];
   $prj = $row_c[1];
}
?>
                        <li>
                            <a href="dashboard.php?c=<?=$_GET[c]; ?>"><?=$com; ?></a>
                        </li>
                        <li>
                            <a href="proj.php?p=<?=$_GET[p]; ?>&c=<?=$_GET[c]; ?>"><?=$prj; ?></a>
                        </li>
                        <li class="active">
                            <strong>Detalles del Pol&iacute;gono</strong>
                        </li>
                    </ol>
                </div>
            </div>
<?
$query_ficha = "SELECT P.Pert_ID, P.Pert_Nombre, P.Pert_NumExp, J.Juzg_Nombre, P.Pert_Lugar, P.Pert_Zona, P.Pert_Datum, P.Pert_HojaIGM, P.Pert_Norte_PIPM, P.Pert_Este_PIPM, P.Pert_N_S, P.Pert_E_W, P.Pert_SupTotal, P.Pert_Nro_Lados, P.Pert_Rol_Minero, P.Pert_Memo, P.Pert_Franco, P.Provincia_Prov_ID, P.Ciudad_Ciud_ID,T.Titu_Nombre, R.Regi_Nombre FROM Pertenencia P, Juzgado J, Titular T, Proyecto Pr, Provincia Pro, Region R, Ciudad C WHERE P.Ciudad_Ciud_ID=C.Ciud_ID and C.Provincia_Prov_ID=Pro.Prov_ID and Pro.Region_Regi_ID=R.Regi_CUT and Pr.Proy_ID=P.Proyecto_Proy_ID and Pr.Titular_Titu_ID=T.Titu_ID and P.Juzgado_Juzg_ID=J.Juzg_ID and P.Pert_ID=$_GET[id_p];";
#print "$query_ficha\n";
$result_ficha = mysqli_query($connect, $query_ficha);
$cont=0;
while($row_f = mysqli_fetch_array($result_ficha)) {
   include_once "lib/phpcoord-2.3.php";
   function UTMtoLL($ec, $nc, $zlc, $znc) {
      $utm = new UTMRef($ec, $nc, $zlc, $znc);
      $ll = $utm->toLatLng();
      return $ll;
   }
#    // Special zone for Chile
#    if ($row_f[9] <= -16 && $ec > -32 && $this->lng >= 3 && $this->lng < 12) {
#        $longitudeZone = 32;
#    }
   $pm=UTMtoLL($row_f[9],$row_f[8],'J',$row_f[5]);
?>
        <div class="row">
            <div class="col-lg-9">
                <div class="wrapper wrapper-content animated fadeInUp">
                    <div class="ibox">
                        <div class="ibox-content">
                            <div class="row">
                                <div class="col-lg-12">
                                    <div class="m-b-md">
                                        <a href="#" class="btn btn-white btn-xs pull-right">Editar pol&iacute;gono</a>
                                        <h2><?=$row_f[1]; ?></h2>
                                    </div>
                                    <dl class="dl-horizontal">
                                        <dt>Estado:</dt> <dd><span class="label label-primary">Activo</span></dd>
                                    </dl>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-lg-7">
                                    <dl class="dl-horizontal">

                                        <dt>Titular:</dt> <dd><?=$row_f[19]; ?></dd>
                                        <dt>Juzgado:</dt> <dd><?=$row_f[3]; ?></dd>
                                        <dt>Regi&oacute;n:</dt> <dd> 	<?=$row_f[20]; ?> </dd>
                                        <dt>Nro Expediente:</dt> <dd><a href="#" class="text-navy"><?=$row_f[2]; ?></a> </dd>
                                        <dt>Superficie Total:</dt> <dd> 	<?=$row_f[12]; ?> Has.</dd>
                                    </dl>
                                </div>
                                <div class="col-lg-5" id="cluster_info">
                                    <dl class="dl-horizontal" >

                                        <dt>POI Norte:</dt> <dd><?=$row_f[8]; ?></dd>
                                        <dt>POI Este:</dt> <dd><?=$row_f[9]; ?></dd>
                                        <dt>Norte/Sur:</dt> <dd><?=$row_f[10]; ?></dd>
                                        <dt>Este/Oeste:</dt> <dd><?=$row_f[11]; ?></dd>
                                        <dt>Nro Lados:</dt> <dd><?=$row_f[13]; ?></dd>
                                        <dt>Participantes:</dt>
                                        <dd class="project-people">
                                        <a href=""><img alt="image" class="img-circle" src="img/a3.jpg"></a>
                                        <a href=""><img alt="image" class="img-circle" src="img/a1.jpg"></a>
                                        </dd>
                                    </dl>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-lg-12">
                                    <dl class="dl-horizontal">
                                        <dt>Estado de avance:</dt>
                                        <dd>
                                            <div class="progress progress-striped active m-b-sm">
                                                <div style="width: 60%;" class="progress-bar"></div>
                                            </div>
                                            <small>El estado de avance de la tramitaci&oacute;n es <strong>60%</strong>. Los plazos est&aacute;n siendo monitoreados.</small>
                                        </dd>
                                    </dl>
                                </div>
                            </div>
<?
}
?>
                            <div class="row m-t-sm">
                                <div class="col-lg-12">
                                <div class="panel blank-panel">
                                <div class="panel-heading">
                                    <div class="panel-options">
                                        <ul class="nav nav-tabs">
                                            <li class="active"><a href="#tab-1" data-toggle="tab">Tr&aacute;mites</a></li>
                                            <li class=""><a href="#tab-2" data-toggle="tab">Ubicaci&oacute;n</a></li>
                                        </ul>
                                    </div>
                                </div>

                                <div class="panel-body">

                                <div class="tab-content">
                                <div class="tab-pane active" id="tab-1">
                                    
                                    <table class="table table-striped">
                                        <thead>
                                        <tr>
                                            <th>Status</th>
                                            <th>Tr&aacute;mite</th>
                                            <th>Presentaci&oacute;n</th>
                                            <th>Comentario</th>
                                        </tr>
                                        </thead>
                                        <tbody>
<?
$query_pt = "SELECT DISTINCT T.Tram_Nombre,TP.TramPert_Fecha as Fecha, TP.TramPert_Memo FROM TramPert TP, Tramite T WHERE T.Tram_Codigo=TP.Tramite_Tram_Codigo AND TP.Pertenencia_Pert_ID=$_GET[id_p] UNION SELECT DISTINCT 'PUBLICACIÓN BOM',TP.TramPert_BoleFec as Fecha, CONCAT('BOLETÍN NRO. ',TP.TramPert_BoleNro) FROM TramPert TP, Tramite T WHERE T.Tram_Codigo=TP.Tramite_Tram_Codigo AND TP.Pertenencia_Pert_ID=$_GET[id_p] ORDER BY Fecha ASC;";
#print "$query_pt\n";
$result_pt = mysqli_query($connect, $query_pt);
if (mysqli_num_rows($result_pt) == 0) {
?>
                                        <tr>
                                            <td colspan="4"><button type="button" class="btn btn-outline btn-danger">Sin registros</button></td>
                                        </tr>
<?
}
while($row_pt = mysqli_fetch_array($result_pt)) {
?>
                                        <tr>
                                            <td><span class="label label-primary"><i class="fa fa-check"></i> Completed</span></td>
                                            <td><?=rtrim($row_pt[0]); ?></td>
                                            <td><?=$row_pt[1]; ?></td>
                                            <td><?=$row_pt[2]; ?></td>
                                        </tr>
<?
}
?>
                                        </tbody>
                                    </table>

                                </div>
                                <div class="tab-pane" id="tab-2">

<div id="map2" class="col-md-8"></div>
<?
$json_url="http://www.mankecura.com/geojson.php?t=".$_GET[id_p];
$ptomedio=$pm[1].", ".$pm[0];
?>
<script>
mapboxgl.accessToken = 'pk.eyJ1IjoiY2JlY2VycmEiLCJhIjoiY2lmbzBjbnc5Z3QwMHJzbTc4NnM4Y2trNSJ9.TmLdONZPGGNYOMlY2V5oZg';
var map = new mapboxgl.Map({
    container: 'map2',
    style: 'mapbox://styles/mapbox/satellite-streets-v9',
    center: [<?php echo $ptomedio; ?>],
    zoom: 11,
    attributionControl: false
});

map.on('load', function () {
    map.addSource('poligono', {
        'type': 'geojson',
        'data': '<?php echo $json_url; ?>'
    });

    map.addLayer({
        'id': 'poligono-fill',
        'type': 'fill',
        'source': 'poligono',
        'layout': {},
        'paint': {
            'fill-color': '#9f2936',
            'fill-opacity': 0.5
        }
    });
});

// When a click event occurs near a polygon, open a popup at the location of
// the feature, with description HTML from its properties.
map.on('click', function (e) {
    var features = map.queryRenderedFeatures(e.point, { layers: ['poligono-fill'] });
    if (!features.length) {
        return;
    }

    var feature = features[0];

    var popup = new mapboxgl.Popup()
        //.setLngLat(feature.geometry.coordinates)
        .setLngLat(map.unproject(e.point))
        .setHTML(feature.properties.description)
        .addTo(map);
});

// Use the same approach as above to indicate that the symbols are clickable
// by changing the cursor style to 'pointer'.
map.on('mousemove', function (e) {
    var features = map.queryRenderedFeatures(e.point, { layers: ['poligono-fill'] });
    map.getCanvas().style.cursor = (features.length) ? 'pointer' : '';
});
</script>

                                </div>
                                </div>

                                </div>

                                </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-lg-3">
                <div class="wrapper wrapper-content project-manager">
                    <h4>Project description</h4>
                    <img src="img/zender_logo.png" class="img-responsive">
                    <p class="small">
                        There are many variations of passages of Lorem Ipsum available, but the majority have suffered alteration in some form, by injected humour, or randomised words which don't look
                        even slightly believable. If you are going to use a passage of Lorem Ipsum, you need to be sure there isn't anything embarrassing
                    </p>
                    <p class="small font-bold">
                        <span><i class="fa fa-circle text-warning"></i> High priority</span>
                    </p>
                    <h5>Project tag</h5>
                    <ul class="tag-list" style="padding: 0">
                        <li><a href=""><i class="fa fa-tag"></i> Zender</a></li>
                        <li><a href=""><i class="fa fa-tag"></i> Lorem ipsum</a></li>
                        <li><a href=""><i class="fa fa-tag"></i> Passages</a></li>
                        <li><a href=""><i class="fa fa-tag"></i> Variations</a></li>
                    </ul>
                    <h5>Project files</h5>
                    <ul class="list-unstyled project-files">
                        <li><a href=""><i class="fa fa-file"></i> Project_document.docx</a></li>
                        <li><a href=""><i class="fa fa-file-picture-o"></i> Logo_zender_company.jpg</a></li>
                        <li><a href=""><i class="fa fa-stack-exchange"></i> Email_from_Alex.mln</a></li>
                        <li><a href=""><i class="fa fa-file"></i> Contract_20_11_2014.docx</a></li>
                    </ul>
                    <div class="text-center m-t-md">
                        <a href="#" class="btn btn-xs btn-primary">Add files</a>
                        <a href="#" class="btn btn-xs btn-primary">Report contact</a>

                    </div>
                </div>
            </div>
        </div>
        <div class="footer">
            <div class="pull-right">
                10GB of <strong>250GB</strong> Free.
            </div>
            <div>
                <strong>Copyright</strong> Example Company &copy; 2015-<?=$anio; ?>
            </div>
        </div>

        </div>
        </div>

    <!-- Mainly scripts -->
    <!-- <script src="js/jquery-2.1.1.js"></script>-->
    <script src="js/bootstrap.min.js"></script>
    <script src="js/plugins/metisMenu/jquery.metisMenu.js"></script>
    <script src="js/plugins/slimscroll/jquery.slimscroll.min.js"></script>

    <!-- Custom and plugin javascript -->
    <script src="js/inspinia.js"></script>
    <script src="js/plugins/pace/pace.min.js"></script>

<!--
    <script>
        $(document).ready(function(){

            $('#loading-example-btn').click(function () {
                btn = $(this);
                simpleLoad(btn, true)

                // Ajax example
//                $.ajax().always(function () {
//                    simpleLoad($(this), false)
//                });

                simpleLoad(btn, false)
            });
        });

        function simpleLoad(btn, state) {
            if (state) {
                btn.children().addClass('fa-spin');
                btn.contents().last().replaceWith(" Loading");
            } else {
                setTimeout(function () {
                    btn.children().removeClass('fa-spin');
                    btn.contents().last().replaceWith(" Refresh");
                }, 2000);
            }
        }
    </script>
-->
</body>

</html>
